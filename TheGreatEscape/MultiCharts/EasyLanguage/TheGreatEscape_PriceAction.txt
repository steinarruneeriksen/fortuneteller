[IntrabarOrderGeneration = true]
inputs:  TicksSL( 20 );
Vars: TickSize( MinMove / PriceScale ),TickValue ((MinMove / PriceScale) * BigPointValue);


// ************  TimeOfDay Filter (TRUE when trading is allowed)************
inputs: Enable_Timefilter(1),TimeOfDay_NonTradingHoursFrom(1655),TimeOfDay_NonTradingHoursTo(1800);
variables: timefilter(false);
if Enable_Timefilter= 1 then begin	
	if  Time>=TimeOfDay_NonTradingHoursFrom and Time <=TimeOfDay_NonTradingHoursTo then
		timefilter=false
	else 
		timefilter=true;
end;
if Enable_Timefilter= 0 then timefilter=true;

// **************   Max loss/profit filter **********************
inputs:
Enable_ProfitLossFilter(1),Daily_Max_Loss(500);
vars:
profitlossfilter(true),
todaynet(0),
yesterdaynet(0);
if date <> date[1] then begin
	yesterdaynet = NetProfit;
end;
//if MarketPosition = 0 then begin
	todaynet = NetProfit - yesterdaynet;
//nd;
profitlossfilter= -Daily_Max_Loss< todaynet ;//and todaynet < Daily_Max_Profit;
if Enable_ProfitLossFilter=0 then profitlossfilter=true;//Always allow



if timefilter then begin
	SetStopShare ;
	SetStopLoss(TicksSL*TickValue) ; 

	if Enable_ProfitLossFilter=1 and profitlossfilter=false then begin
		if mp>0 then sell next bar at market;
		if mp<0 then buytocover next bar at market;
	end;	
end;


Condition5= timefilter and  profitlossfilter;


vars: upbar(0),lowbar(0);
upbar=absvalue(h[1]-h[0]);
lowbar=absvalue(l[1]-l[0]);


input: StopOrderRestricted(true),StopOrderSimple(true), StopOrderAvgCount(2);

vars: lowtest(0), hightest(0);
if BarNumber>2 then begin
	if StopOrderSimple then begin
		lowtest=l[1];
		hightest=h[1];
	end else begin
		lowtest=Average(l,StopOrderAvgCount);
		hightest=Average(h,StopOrderAvgCount);	
	end;
end;


if Condition5 then begin
	
	if StopOrderRestricted then begin
		if lowtest>0 and c>lowtest and c<hightest  then sellshort("S.2") next bar at lowtest stop;
		if hightest>0 and c<hightest and c>lowtest then buy("B.2") next bar at hightest stop;
	end else begin
		if lowtest>0  then sellshort("S.3") next bar at lowtest stop;
		if hightest>0  then buy("B.3") next bar at hightest stop;
	end;

	If ( lowbar<upbar) then 

	begin
		if c>o then 
	  		sellshort("S.1.1") next bar at market
	  	else buy("B.1.2")  next bar at market;
	end;


	If ( lowbar>upbar ) then 
	begin
		if c<o then
	 	 buy("B.1.1")  next bar at market
	 	else sellshort("S.1.2")  next bar at market;
	end;
end;
